Switching to cluster2:



kubectl config use-context cluster2




The easiest way to route traffic to a specific pod is by the use of labels and selectors . List the pods along with their labels:



student-node ~ ➜  kubectl get pods --show-labels 
NAME     READY   STATUS    RESTARTS   AGE     LABELS
lambda   1/1     Running   0          5m21s   env=dev,mode=standard,type=external
alpha   1/1     Running   0          5m20s   env=dev,mode=standard,type=internal
delta   1/1     Running   0          5m20s   env=prod,mode=exam,type=internal
beta   1/1     Running   0          5m21s   env=dev,mode=exam,type=external
sigma   1/1     Running   0          5m20s   env=prod,mode=standard,type=internal
gamma   1/1     Running   0          5m20s   env=prod,mode=exam,type=external




Looks like there are a lot of pods created to confuse us. But we are only concerned with the labels of beta and gamma.



As we can see both the required pods have labels mode=exam,type=external in common. Let's confirm that using kubectl too:



student-node ~ ➜  kubectl get pod -l mode=exam,type=external                                       
NAME     READY   STATUS    RESTARTS   AGE
beta   1/1     Running   0          9m18s
gamma   1/1     Running   0          9m17s




Nice!! Now as we have figured out the labels, we can proceed further with the creation of the service:



student-node ~ ➜  kubectl create service clusterip radioactive-service --tcp=8080:80 --dry-run=client -o yaml > radioactive-service.yaml




Now modify the service definition with selectors as required before applying to k8s cluster:



student-node ~ ➜  cat radioactive-service.yaml 
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: null
  labels:
    app: radioactive-service
  name: radioactive-service
spec:
  ports:
  - name: 8080-80
    port: 8080
    protocol: TCP
    targetPort: 80
  selector:
    app: radioactive-service  # delete 
    mode: exam    # add
    type: external  # add
  type: ClusterIP
status:
  loadBalancer: {}




Finally let's apply the service definition:



student-node ~ ➜  kubectl apply -f radioactive-service.yaml
service/service-3421 created

student-node ~ ➜  k get ep radioactive-service 
NAME           ENDPOINTS                     AGE
service-3421   10.42.0.15:80,10.42.0.17:80   52s




To store all the pod name along with their IP's , we could use imperative command as shown below:



student-node ~ ➜  kubectl get pods -A -o=custom-columns='POD_NAME:metadata.name,IP_ADDR:status.podIP' --sort-by=.status.podIP

POD_NAME                                  IP_ADDR
helm-install-traefik-crd-lbwzr            10.42.0.2
local-path-provisioner-7b7dc8d6f5-d4x7t   10.42.0.3
metrics-server-668d979685-vh7bk           10.42.0.4
...

# store the output to /root/pod_ips_ckad02_svcn
student-node ~ ➜  kubectl get pods -A -o=custom-columns='POD_NAME:metadata.name,IP_ADDR:status.podIP' --sort-by=.status.podIP > /root/pod_ips_ckad02_svcn