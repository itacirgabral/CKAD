# 16 log initContainer
The Tech Lead of Mercury2D decided it's time for more logging, to finally fight all these missing data incidents. There is an existing
container named cleaner-con in Deployment cleaner in Namespace mercury . This container mounts a volume and writes logs
into a file called cleaner.log .
The yaml for the existing Deployment is available at /opt/course/16/cleaner.yaml . Persist your changes at /opt/course/16/
cleaner-new.yaml on ckad7326 but also make sure the Deployment is running.
Create a sidecar container named logger-con , image busybox:1.31.0 , which mounts the same volume and writes the content
of cleaner.log to stdout, you can use the tail -f command for this. This way it can be picked up by kubectl logs .
Check if the logs of the new container reveal something about the missing data incidents.


GPT Sim — a frase “Sidecar containers in K8s are initContainers with restartPolicy: Always” está errada ou, no mínimo, muito enganosa.

Você está absolutamente correto em questionar a possibilidade de definir containers sidecar dentro de `initContainers` no Kubernetes. A partir da versão **1.28**, o Kubernetes introduziu suporte nativo para containers sidecar dentro de `initContainers`, permitindo que esses containers sejam **reiniciáveis** durante a vida útil do Pod. ([Kubernetes][1])

### ✅ O que isso significa?

* **Definição de Sidecar em `initContainers`**: Você pode agora definir containers sidecar dentro de `initContainers` usando a propriedade `restartPolicy: Always`. Isso permite que o container sidecar seja iniciado antes do container principal e continue em execução durante toda a vida útil do Pod.

* **Comportamento de Reinício**: Com `restartPolicy: Always`, o sidecar será reiniciado automaticamente se falhar, sem afetar o container principal. Isso é útil para tarefas como logging contínuo ou monitoramento.

* **Compatibilidade com Pods e Jobs**: Essa funcionalidade é compatível tanto com Pods quanto com Jobs, permitindo maior flexibilidade na definição de containers sidecar.

### ⚠️ Considerações Importantes

* **Versão do Kubernetes**: Essa funcionalidade está disponível a partir da versão 1.28. Certifique-se de que seu cluster esteja executando essa versão ou superior.

* **Habilitação do Feature Gate**: O recurso `SidecarContainers` deve estar habilitado no seu cluster. Em versões anteriores, ele estava em alpha, mas foi estabilizado na versão 1.33.

* **Uso Adequado**: Embora seja possível definir sidecars em `initContainers`, é importante avaliar se esse é o padrão mais adequado para seu caso de uso. Containers sidecar geralmente são usados para funcionalidades que precisam estar em execução durante toda a vida útil do Pod, como logging ou proxying.

### 📄 Exemplo de YAML

Aqui está um exemplo de como definir um container sidecar dentro de `initContainers`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      initContainers:
        - name: logshipper
          image: alpine:latest
          restartPolicy: Always
          command: ['sh', '-c', 'tail -F /opt/logs.txt']
          volumeMounts:
            - name: data
              mountPath: /opt
      containers:
        - name: myapp
          image: alpine:latest
          command: ['sh', '-c', 'while true; do echo "logging" >> /opt/logs.txt; sleep 1; done']
          volumeMounts:
            - name: data
              mountPath: /opt
      volumes:
        - name: data
          emptyDir: {}
```

Neste exemplo, o container `logshipper` é definido dentro de `initContainers` com `restartPolicy: Always`, permitindo que ele atue como um sidecar reiniciável.

Se você tiver mais dúvidas ou precisar de assistência adicional, estou à disposição para ajudar!

[1]: https://kubernetes.io/blog/2023/08/25/native-sidecar-containers/?utm_source=chatgpt.com "Kubernetes v1.28: Introducing native sidecar containers"
