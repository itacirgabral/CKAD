# 16 log initContainer
The Tech Lead of Mercury2D decided it's time for more logging, to finally fight all these missing data incidents. There is an existing
container named cleaner-con in Deployment cleaner in Namespace mercury . This container mounts a volume and writes logs
into a file called cleaner.log .
The yaml for the existing Deployment is available at /opt/course/16/cleaner.yaml . Persist your changes at /opt/course/16/
cleaner-new.yaml on ckad7326 but also make sure the Deployment is running.
Create a sidecar container named logger-con , image busybox:1.31.0 , which mounts the same volume and writes the content
of cleaner.log to stdout, you can use the tail -f command for this. This way it can be picked up by kubectl logs .
Check if the logs of the new container reveal something about the missing data incidents.


GPT Sim â€” a frase â€œSidecar containers in K8s are initContainers with restartPolicy: Alwaysâ€ estÃ¡ errada ou, no mÃ­nimo, muito enganosa.

VocÃª estÃ¡ absolutamente correto em questionar a possibilidade de definir containers sidecar dentro de `initContainers` no Kubernetes. A partir da versÃ£o **1.28**, o Kubernetes introduziu suporte nativo para containers sidecar dentro de `initContainers`, permitindo que esses containers sejam **reiniciÃ¡veis** durante a vida Ãºtil do Pod. ([Kubernetes][1])

### âœ… O que isso significa?

* **DefiniÃ§Ã£o de Sidecar em `initContainers`**: VocÃª pode agora definir containers sidecar dentro de `initContainers` usando a propriedade `restartPolicy: Always`. Isso permite que o container sidecar seja iniciado antes do container principal e continue em execuÃ§Ã£o durante toda a vida Ãºtil do Pod.

* **Comportamento de ReinÃ­cio**: Com `restartPolicy: Always`, o sidecar serÃ¡ reiniciado automaticamente se falhar, sem afetar o container principal. Isso Ã© Ãºtil para tarefas como logging contÃ­nuo ou monitoramento.

* **Compatibilidade com Pods e Jobs**: Essa funcionalidade Ã© compatÃ­vel tanto com Pods quanto com Jobs, permitindo maior flexibilidade na definiÃ§Ã£o de containers sidecar.

### âš ï¸ ConsideraÃ§Ãµes Importantes

* **VersÃ£o do Kubernetes**: Essa funcionalidade estÃ¡ disponÃ­vel a partir da versÃ£o 1.28. Certifique-se de que seu cluster esteja executando essa versÃ£o ou superior.

* **HabilitaÃ§Ã£o do Feature Gate**: O recurso `SidecarContainers` deve estar habilitado no seu cluster. Em versÃµes anteriores, ele estava em alpha, mas foi estabilizado na versÃ£o 1.33.

* **Uso Adequado**: Embora seja possÃ­vel definir sidecars em `initContainers`, Ã© importante avaliar se esse Ã© o padrÃ£o mais adequado para seu caso de uso. Containers sidecar geralmente sÃ£o usados para funcionalidades que precisam estar em execuÃ§Ã£o durante toda a vida Ãºtil do Pod, como logging ou proxying.

### ğŸ“„ Exemplo de YAML

Aqui estÃ¡ um exemplo de como definir um container sidecar dentro de `initContainers`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      initContainers:
        - name: logshipper
          image: alpine:latest
          restartPolicy: Always
          command: ['sh', '-c', 'tail -F /opt/logs.txt']
          volumeMounts:
            - name: data
              mountPath: /opt
      containers:
        - name: myapp
          image: alpine:latest
          command: ['sh', '-c', 'while true; do echo "logging" >> /opt/logs.txt; sleep 1; done']
          volumeMounts:
            - name: data
              mountPath: /opt
      volumes:
        - name: data
          emptyDir: {}
```

Neste exemplo, o container `logshipper` Ã© definido dentro de `initContainers` com `restartPolicy: Always`, permitindo que ele atue como um sidecar reiniciÃ¡vel.

Se vocÃª tiver mais dÃºvidas ou precisar de assistÃªncia adicional, estou Ã  disposiÃ§Ã£o para ajudar!

[1]: https://kubernetes.io/blog/2023/08/25/native-sidecar-containers/?utm_source=chatgpt.com "Kubernetes v1.28: Introducing native sidecar containers"
